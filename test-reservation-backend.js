/**
 * Script de test pour les fonctionnalit√©s de r√©servation c√¥t√© backend
 * Teste les diff√©rentes routes et sc√©narios de r√©servation
 */

const axios = require('axios');

// Configuration
const BASE_URL = 'http://localhost:3000/api';
const API_TIMEOUT = 10000;

// Couleurs pour les logs
const colors = {
    reset: '\x1b[0m',
    bright: '\x1b[1m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    magenta: '\x1b[35m',
    cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
    console.log(`${colors[color]}${message}${colors.reset}`);
}

function logSuccess(message) {
    log(`‚úÖ ${message}`, 'green');
}

function logError(message) {
    log(`‚ùå ${message}`, 'red');
}

function logInfo(message) {
    log(`‚ÑπÔ∏è  ${message}`, 'blue');
}

function logWarning(message) {
    log(`‚ö†Ô∏è  ${message}`, 'yellow');
}

// Configuration axios
const api = axios.create({
    baseURL: BASE_URL,
    timeout: API_TIMEOUT,
    headers: {
        'Content-Type': 'application/json'
    }
});

// Variables globales pour les tests
let testTrajetId = null;
let testReservationId = null;
let testGuestReservationId = null;
let authToken = null;

// ========== TESTS DES TRAJETS ==========

async function testGetTrajets() {
    logInfo('üîç Test 1: R√©cup√©ration des trajets disponibles');
    
    try {
        const response = await api.get('/trajets');
        
        if (response.data.success && response.data.data.length > 0) {
            testTrajetId = response.data.data[0].id;
            logSuccess(`Trajets r√©cup√©r√©s: ${response.data.data.length} trajets trouv√©s`);
            logInfo(`Trajet de test s√©lectionn√©: ID ${testTrajetId}`);
            
            // Afficher les d√©tails du trajet de test
            const trajet = response.data.data[0];
            logInfo(`D√©tails du trajet de test:`);
            logInfo(`  - D√©part: ${trajet.departure_city} ‚Üí ${trajet.arrival_city}`);
            logInfo(`  - Date: ${new Date(trajet.departure_time).toLocaleString('fr-FR')}`);
            logInfo(`  - Prix: ${trajet.price} FCFA`);
            logInfo(`  - Places disponibles: ${trajet.available_seats}`);
            logInfo(`  - Statut: ${trajet.status}`);
            
            return true;
        } else {
            logError('Aucun trajet trouv√©');
            return false;
        }
    } catch (error) {
        logError(`Erreur lors de la r√©cup√©ration des trajets: ${error.message}`);
        if (error.response) {
            logError(`D√©tails: ${JSON.stringify(error.response.data, null, 2)}`);
        }
        return false;
    }
}

async function createTestTrajet() {
    logInfo('üîç Test 1.1: Cr√©ation d\'un trajet de test');
    
    try {
        // Date de demain √† 10h00
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(10, 0, 0, 0);
        
        const trajetData = {
            departure_city: 'Bamako',
            arrival_city: 'Sikasso',
            departure_time: tomorrow.toISOString(),
            price: 5000,
            seats_count: 20,
            available_seats: 20,
            departure_point: 'Gare routi√®re de Bamako',
            arrival_point: 'Gare routi√®re de Sikasso',
            accepts_packages: true,
            max_package_weight: 25
        };
        
        const response = await api.post('/trajets', trajetData, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.data.success) {
            testTrajetId = response.data.data.id;
            logSuccess(`Trajet de test cr√©√© avec succ√®s: ID ${testTrajetId}`);
            return true;
        } else {
            logError('√âchec de la cr√©ation du trajet de test');
            return false;
        }
    } catch (error) {
        logError(`Erreur lors de la cr√©ation du trajet: ${error.message}`);
        return false;
    }
}

// ========== TESTS D'AUTHENTIFICATION ==========

async function testLogin() {
    logInfo('üîê Test 0: Authentification pour les tests');
    
    try {
        const loginData = {
            email: 'admin@billettigue.com',
            password: 'admin123'
        };
        
        const response = await api.post('/auth/login', loginData);
        
        if (response.data.success && response.data.token) {
            authToken = response.data.token;
            logSuccess('Authentification r√©ussie');
            logInfo(`Token re√ßu: ${authToken.substring(0, 20)}...`);
            return true;
        } else {
            logError('√âchec de l\'authentification');
            return false;
        }
    } catch (error) {
        logError(`Erreur d'authentification: ${error.message}`);
        return false;
    }
}

// ========== TESTS DE R√âSERVATION INVIT√â ==========

async function testGuestReservation() {
    logInfo('üé´ Test 2: R√©servation invit√© (sans compte)');
    
    if (!testTrajetId) {
        logError('Aucun trajet disponible pour le test');
        return false;
    }
    
    try {
        const reservationData = {
            trajet_id: testTrajetId,
            seats_reserved: 2,
            passenger_first_name: 'Moussa',
            passenger_last_name: 'Diallo',
            phone_number: '+223 12345678',
            refundable_option: false,
            refund_supplement_amount: 0,
            total_amount: 10000 // 2 places * 5000 FCFA
        };
        
        const response = await api.post('/reservations/guest', reservationData);
        
        if (response.data.success) {
            testGuestReservationId = response.data.data.id;
            logSuccess(`R√©servation invit√© cr√©√©e avec succ√®s: ID ${testGuestReservationId}`);
            logInfo(`R√©f√©rence: ${response.data.data.reference}`);
            logInfo(`Montant total: ${response.data.data.total_amount} FCFA`);
            return true;
        } else {
            logError('√âchec de la cr√©ation de la r√©servation invit√©');
            return false;
        }
    } catch (error) {
        logError(`Erreur lors de la r√©servation invit√©: ${error.message}`);
        if (error.response) {
            logError(`D√©tails: ${JSON.stringify(error.response.data, null, 2)}`);
        }
        return false;
    }
}

async function testGuestReservationValidation() {
    logInfo('üé´ Test 2.1: Validation des donn√©es de r√©servation invit√©');
    
    if (!testTrajetId) {
        logError('Aucun trajet disponible pour le test');
        return false;
    }
    
    const testCases = [
        {
            name: 'Donn√©es manquantes',
            data: {
                trajet_id: testTrajetId,
                // passenger_first_name manquant
                passenger_last_name: 'Diallo',
                phone_number: '+223 12345678'
            },
            expectedError: 'obligatoires'
        },
        {
            name: 'Nombre de places invalide',
            data: {
                trajet_id: testTrajetId,
                seats_reserved: 0,
                passenger_first_name: 'Moussa',
                passenger_last_name: 'Diallo',
                phone_number: '+223 12345678'
            },
            expectedError: 'entre 1 et 10'
        },
        {
            name: 'Num√©ro de t√©l√©phone invalide',
            data: {
                trajet_id: testTrajetId,
                seats_reserved: 1,
                passenger_first_name: 'Moussa',
                passenger_last_name: 'Diallo',
                phone_number: '123' // Trop court
            },
            expectedError: 't√©l√©phone invalide'
        }
    ];
    
    for (const testCase of testCases) {
        try {
            logInfo(`Test: ${testCase.name}`);
            await api.post('/reservations/guest', testCase.data);
            logError(`Test √©chou√©: ${testCase.name} - Aucune erreur lev√©e`);
        } catch (error) {
            if (error.response && error.response.data.message.includes(testCase.expectedError)) {
                logSuccess(`Validation r√©ussie: ${testCase.name}`);
            } else {
                logError(`Validation √©chou√©e: ${testCase.name} - Erreur inattendue`);
            }
        }
    }
}

// ========== TESTS DE R√âSERVATION UTILISATEUR ==========

async function testUserReservation() {
    logInfo('üé´ Test 3: R√©servation utilisateur (avec compte)');
    
    if (!testTrajetId || !authToken) {
        logError('Trajet ou token d\'authentification manquant');
        return false;
    }
    
    try {
        const reservationData = {
            trajet_id: testTrajetId,
            seats_reserved: 1,
            passenger_first_name: 'Fatou',
            passenger_last_name: 'Traor√©',
            phone_number: '+223 87654321'
        };
        
        const response = await api.post('/reservations', reservationData, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.data.success) {
            testReservationId = response.data.data.id;
            logSuccess(`R√©servation utilisateur cr√©√©e avec succ√®s: ID ${testReservationId}`);
            logInfo(`Statut: ${response.data.data.status}`);
            logInfo(`Montant: ${response.data.data.total_amount} FCFA`);
            return true;
        } else {
            logError('√âchec de la cr√©ation de la r√©servation utilisateur');
            return false;
        }
    } catch (error) {
        logError(`Erreur lors de la r√©servation utilisateur: ${error.message}`);
        if (error.response) {
            logError(`D√©tails: ${JSON.stringify(error.response.data, null, 2)}`);
        }
        return false;
    }
}

// ========== TESTS DE R√âCUP√âRATION DES R√âSERVATIONS ==========

async function testGetMyReservations() {
    logInfo('üìã Test 4: R√©cup√©ration de mes r√©servations');
    
    if (!authToken) {
        logError('Token d\'authentification manquant');
        return false;
    }
    
    try {
        const response = await api.get('/reservations', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.data.success) {
            logSuccess(`R√©servations r√©cup√©r√©es: ${response.data.data.length} r√©servations`);
            
            if (response.data.data.length > 0) {
                const reservation = response.data.data[0];
                logInfo(`Exemple de r√©servation:`);
                logInfo(`  - ID: ${reservation.id}`);
                logInfo(`  - Statut: ${reservation.status}`);
                logInfo(`  - Passager: ${reservation.passenger_first_name} ${reservation.passenger_last_name}`);
                logInfo(`  - Date: ${new Date(reservation.reservation_date).toLocaleString('fr-FR')}`);
            }
            return true;
        } else {
            logError('√âchec de la r√©cup√©ration des r√©servations');
            return false;
        }
    } catch (error) {
        logError(`Erreur lors de la r√©cup√©ration des r√©servations: ${error.message}`);
        return false;
    }
}

async function testGetReservationById() {
    logInfo('üìã Test 5: R√©cup√©ration d\'une r√©servation sp√©cifique');
    
    if (!testReservationId || !authToken) {
        logError('ID de r√©servation ou token manquant');
        return false;
    }
    
    try {
        const response = await api.get(`/reservations/${testReservationId}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.data.success) {
            const reservation = response.data.data;
            logSuccess(`R√©servation r√©cup√©r√©e: ID ${reservation.id}`);
            logInfo(`D√©tails complets:`);
            logInfo(`  - Statut: ${reservation.status}`);
            logInfo(`  - Passager: ${reservation.passenger_first_name} ${reservation.passenger_last_name}`);
            logInfo(`  - T√©l√©phone: ${reservation.phone_number}`);
            logInfo(`  - Places: ${reservation.seats_reserved}`);
            logInfo(`  - Montant: ${reservation.total_amount} FCFA`);
            logInfo(`  - Trajet: ${reservation.trajet?.departure_city} ‚Üí ${reservation.trajet?.arrival_city}`);
            return true;
        } else {
            logError('√âchec de la r√©cup√©ration de la r√©servation');
            return false;
        }
    } catch (error) {
        logError(`Erreur lors de la r√©cup√©ration de la r√©servation: ${error.message}`);
        return false;
    }
}

// ========== TESTS D'ANNULATION ==========

async function testCancelReservation() {
    logInfo('‚ùå Test 6: Annulation d\'une r√©servation');
    
    if (!testReservationId || !authToken) {
        logError('ID de r√©servation ou token manquant');
        return false;
    }
    
    try {
        const response = await api.put(`/reservations/${testReservationId}/cancel`, {}, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.data.success) {
            logSuccess(`R√©servation annul√©e avec succ√®s: ID ${testReservationId}`);
            logInfo(`Nouveau statut: ${response.data.data.status}`);
            if (response.data.data.paiement) {
                logInfo(`Statut paiement: ${response.data.data.paiement.status}`);
            }
            return true;
        } else {
            logError('√âchec de l\'annulation de la r√©servation');
            return false;
        }
    } catch (error) {
        logError(`Erreur lors de l'annulation: ${error.message}`);
        if (error.response) {
            logError(`D√©tails: ${JSON.stringify(error.response.data, null, 2)}`);
        }
        return false;
    }
}

// ========== TESTS DE STATISTIQUES ==========

async function testReservationStats() {
    logInfo('üìä Test 7: Statistiques des r√©servations');
    
    if (!authToken) {
        logError('Token d\'authentification manquant');
        return false;
    }
    
    try {
        const response = await api.get('/reservations/stats/overview', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.data.success) {
            const stats = response.data.data;
            logSuccess('Statistiques r√©cup√©r√©es avec succ√®s');
            logInfo(`R√©sum√©:`);
            logInfo(`  - Total r√©servations: ${stats.total}`);
            logInfo(`  - Confirm√©es: ${stats.confirmed}`);
            logInfo(`  - En attente: ${stats.pending}`);
            logInfo(`  - Annul√©es: ${stats.cancelled}`);
            logInfo(`  - Termin√©es: ${stats.completed}`);
            return true;
        } else {
            logError('√âchec de la r√©cup√©ration des statistiques');
            return false;
        }
    } catch (error) {
        logError(`Erreur lors de la r√©cup√©ration des statistiques: ${error.message}`);
        return false;
    }
}

// ========== FONCTION PRINCIPALE ==========

async function runAllTests() {
    log('üöÄ D√©marrage des tests de r√©servation backend', 'bright');
    log('=' * 50, 'cyan');
    
    const results = {
        total: 0,
        passed: 0,
        failed: 0
    };
    
    const tests = [
        { name: 'Authentification', fn: testLogin },
        { name: 'R√©cup√©ration trajets', fn: testGetTrajets },
        { name: 'R√©servation invit√©', fn: testGuestReservation },
        { name: 'Validation r√©servation invit√©', fn: testGuestReservationValidation },
        { name: 'R√©servation utilisateur', fn: testUserReservation },
        { name: 'R√©cup√©ration mes r√©servations', fn: testGetMyReservations },
        { name: 'R√©cup√©ration r√©servation sp√©cifique', fn: testGetReservationById },
        { name: 'Annulation r√©servation', fn: testCancelReservation },
        { name: 'Statistiques r√©servations', fn: testReservationStats }
    ];
    
    for (const test of tests) {
        results.total++;
        log(`\nüß™ Test ${results.total}: ${test.name}`, 'magenta');
        
        try {
            const success = await test.fn();
            if (success) {
                results.passed++;
                logSuccess(`${test.name} - R√âUSSI`);
            } else {
                results.failed++;
                logError(`${test.name} - √âCHOU√â`);
            }
        } catch (error) {
            results.failed++;
            logError(`${test.name} - ERREUR: ${error.message}`);
        }
        
        // Pause entre les tests
        await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    // R√©sum√© final
    log('\n' + '=' * 50, 'cyan');
    log('üìä R√âSUM√â DES TESTS', 'bright');
    log(`Total: ${results.total}`, 'cyan');
    log(`R√©ussis: ${results.passed}`, 'green');
    log(`√âchou√©s: ${results.failed}`, 'red');
    log(`Taux de r√©ussite: ${((results.passed / results.total) * 100).toFixed(1)}%`, 'yellow');
    
    if (results.failed === 0) {
        log('\nüéâ TOUS LES TESTS SONT PASS√âS !', 'green');
    } else {
        log('\n‚ö†Ô∏è  Certains tests ont √©chou√©. V√©rifiez les logs ci-dessus.', 'yellow');
    }
}

// Ex√©cution des tests
if (require.main === module) {
    runAllTests().catch(error => {
        logError(`Erreur fatale: ${error.message}`);
        process.exit(1);
    });
}

module.exports = {
    runAllTests,
    testLogin,
    testGetTrajets,
    testGuestReservation,
    testUserReservation,
    testGetMyReservations,
    testCancelReservation,
    testReservationStats
}; 